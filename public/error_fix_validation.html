<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Fix Validation - Vehicle Recon Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .test-result {
            transition: all 0.3s ease;
        }
        .test-success {
            background-color: #d1fae5;
            border-color: #22c55e;
            color: #166534;
        }
        .test-error {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #dc2626;
        }
        .test-pending {
            background-color: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
        <header class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-bug-slash text-green-600 mr-3"></i>
                Error Fix Validation Report
            </h1>
            <p class="text-gray-600">Testing all fixed issues in the Vehicle Reconditioning Tracker</p>
            <div class="mt-4 flex gap-4">
                <button onclick="runAllTests()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                    <i class="fas fa-play mr-2"></i>Run All Tests
                </button>
                <button onclick="location.href='http://localhost:3001'" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                    <i class="fas fa-external-link-alt mr-2"></i>Open Main Application
                </button>
            </div>
        </header>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">Test Results Summary</h2>
            <div id="summary" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                    <i class="fas fa-check-circle text-3xl text-green-600 mb-2"></i>
                    <div class="text-2xl font-bold text-green-600" id="passed-count">0</div>
                    <div class="text-sm text-green-800">Tests Passed</div>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                    <i class="fas fa-times-circle text-3xl text-red-600 mb-2"></i>
                    <div class="text-2xl font-bold text-red-600" id="failed-count">0</div>
                    <div class="text-sm text-red-800">Tests Failed</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <i class="fas fa-clock text-3xl text-yellow-600 mb-2"></i>
                    <div class="text-2xl font-bold text-yellow-600" id="pending-count">0</div>
                    <div class="text-sm text-yellow-800">Tests Pending</div>
                </div>
            </div>
        </div>

        <div class="space-y-4" id="test-results">
            <!-- Test results will be populated here -->
        </div>
    </div>

    <script>
        const tests = [
            {
                name: 'Server Connectivity',
                description: 'Verify that the backend server is running and accessible',
                test: async () => {
                    const response = await fetch('http://localhost:3001/api/inventory/current');
                    return response.status === 200 || response.status === 404; // 404 is OK if no inventory file
                }
            },
            {
                name: 'Main Application Load',
                description: 'Check if the main application HTML loads without errors',
                test: async () => {
                    const response = await fetch('http://localhost:3001');
                    const html = await response.text();
                    return html.includes('Vehicle Reconditioning Tracker') && response.status === 200;
                }
            },
            {
                name: 'JavaScript File Load',
                description: 'Verify main.js loads without syntax errors',
                test: async () => {
                    const response = await fetch('http://localhost:3001/main.js');
                    return response.status === 200;
                }
            },
            {
                name: 'Global Functions Available',
                description: 'Check if key window functions are defined',
                test: async () => {
                    // Test by loading the main app in an iframe and checking functions
                    return new Promise((resolve) => {
                        const iframe = document.createElement('iframe');
                        iframe.src = 'http://localhost:3001';
                        iframe.style.display = 'none';
                        iframe.onload = () => {
                            try {
                                const win = iframe.contentWindow;
                                const hasFunctions = [
                                    'showVehicleDetailModal',
                                    'showAddVehicleModal',
                                    'toggleWorkflowStep',
                                    'exportToCSV'
                                ].every(func => typeof win[func] === 'function');
                                document.body.removeChild(iframe);
                                resolve(hasFunctions);
                            } catch (error) {
                                document.body.removeChild(iframe);
                                resolve(false);
                            }
                        };
                        iframe.onerror = () => {
                            document.body.removeChild(iframe);
                            resolve(false);
                        };
                        document.body.appendChild(iframe);
                    });
                }
            },
            {
                name: 'PhotoManager Initialization',
                description: 'Verify PhotoManager class is properly instantiated',
                test: async () => {
                    return new Promise((resolve) => {
                        const iframe = document.createElement('iframe');
                        iframe.src = 'http://localhost:3001';
                        iframe.style.display = 'none';
                        iframe.onload = () => {
                            try {
                                const win = iframe.contentWindow;
                                const hasPhotoManager = win.photoManager && 
                                                      typeof win.photoManager.openPhotoGallery === 'function';
                                document.body.removeChild(iframe);
                                resolve(hasPhotoManager);
                            } catch (error) {
                                document.body.removeChild(iframe);
                                resolve(false);
                            }
                        };
                        iframe.onerror = () => {
                            document.body.removeChild(iframe);
                            resolve(false);
                        };
                        document.body.appendChild(iframe);
                    });
                }
            },
            {
                name: 'VIN Scanner Functions',
                description: 'Check if VIN scanner functions are available',
                test: async () => {
                    return new Promise((resolve) => {
                        const iframe = document.createElement('iframe');
                        iframe.src = 'http://localhost:3001';
                        iframe.style.display = 'none';
                        iframe.onload = () => {
                            try {
                                const win = iframe.contentWindow;
                                const hasVinFunctions = [
                                    'startVinScanner',
                                    'captureVin',
                                    'closeVinScanner'
                                ].every(func => typeof win[func] === 'function');
                                document.body.removeChild(iframe);
                                resolve(hasVinFunctions);
                            } catch (error) {
                                document.body.removeChild(iframe);
                                resolve(false);
                            }
                        };
                        iframe.onerror = () => {
                            document.body.removeChild(iframe);
                            resolve(false);
                        };
                        document.body.appendChild(iframe);
                    });
                }
            },
            {
                name: 'DOMContentLoaded Issues Fixed',
                description: 'Verify no duplicate initialization conflicts',
                test: async () => {
                    const response = await fetch('http://localhost:3001/main.js');
                    const jsContent = await response.text();
                    const domContentLoadedMatches = jsContent.match(/addEventListener\s*\(\s*['"]DOMContentLoaded['\"]/g);
                    return domContentLoadedMatches && domContentLoadedMatches.length === 1;
                }
            },
            {
                name: 'Utility Functions Available',
                description: 'Check if utility functions are properly defined',
                test: async () => {
                    return new Promise((resolve) => {
                        const iframe = document.createElement('iframe');
                        iframe.src = 'http://localhost:3001';
                        iframe.style.display = 'none';
                        iframe.onload = () => {
                            try {
                                const win = iframe.contentWindow;
                                const hasUtilities = [
                                    'calculateDaysInProcess',
                                    'calculateVehicleProgress',
                                    'hasPhotosInCSV',
                                    'autoSave'
                                ].every(func => typeof win[func] === 'function');
                                document.body.removeChild(iframe);
                                resolve(hasUtilities);
                            } catch (error) {
                                document.body.removeChild(iframe);
                                resolve(false);
                            }
                        };
                        iframe.onerror = () => {
                            document.body.removeChild(iframe);
                            resolve(false);
                        };
                        document.body.appendChild(iframe);
                    });
                }
            },
            {
                name: 'Dashboard Rendering',
                description: 'Verify dashboard loads and renders correctly',
                test: async () => {
                    return new Promise((resolve) => {
                        const iframe = document.createElement('iframe');
                        iframe.src = 'http://localhost:3001';
                        iframe.style.display = 'none';
                        iframe.onload = () => {
                            setTimeout(() => {
                                try {
                                    const doc = iframe.contentDocument;
                                    const dashboardContent = doc.getElementById('dashboard-content');
                                    const vehicleCountElements = doc.querySelectorAll('#total-active-count, #mechanical-count, #detailing-count, #lot-ready-count');
                                    document.body.removeChild(iframe);
                                    resolve(dashboardContent && vehicleCountElements.length === 4);
                                } catch (error) {
                                    document.body.removeChild(iframe);
                                    resolve(false);
                                }
                            }, 2000);
                        };
                        iframe.onerror = () => {
                            document.body.removeChild(iframe);
                            resolve(false);
                        };
                        document.body.appendChild(iframe);
                    });
                }
            },
            {
                name: 'No Console Errors',
                description: 'Verify no JavaScript console errors on page load',
                test: async () => {
                    // This is a simplified test - in a real scenario you'd use browser automation
                    const response = await fetch('http://localhost:3001/main.js');
                    const jsContent = await response.text();
                    // Check for common error patterns
                    const hasErrorPatterns = /undefined\s+is\s+not\s+a\s+function|Cannot\s+read\s+property|ReferenceError/i.test(jsContent);
                    return !hasErrorPatterns;
                }
            }
        ];

        async function runAllTests() {
            const resultsContainer = document.getElementById('test-results');
            const passedCount = document.getElementById('passed-count');
            const failedCount = document.getElementById('failed-count');
            const pendingCount = document.getElementById('pending-count');
            
            let passed = 0;
            let failed = 0;
            let pending = tests.length;
            
            pendingCount.textContent = pending;
            passedCount.textContent = passed;
            failedCount.textContent = failed;
            
            resultsContainer.innerHTML = '';
            
            for (const [index, test] of tests.entries()) {
                const testElement = createTestElement(test, index);
                resultsContainer.appendChild(testElement);
                
                try {
                    const result = await test.test();
                    if (result) {
                        updateTestResult(index, 'success', 'Test passed successfully');
                        passed++;
                    } else {
                        updateTestResult(index, 'error', 'Test failed');
                        failed++;
                    }
                } catch (error) {
                    updateTestResult(index, 'error', `Test failed: ${error.message}`);
                    failed++;
                }
                
                pending--;
                passedCount.textContent = passed;
                failedCount.textContent = failed;
                pendingCount.textContent = pending;
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // Show final summary
            if (failed === 0) {
                alert(`🎉 All tests passed! The application errors have been successfully fixed.`);
            } else {
                alert(`⚠️ ${failed} test(s) failed. Please check the results for details.`);
            }
        }
        
        function createTestElement(test, index) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow p-6 test-result test-pending';
            div.id = `test-${index}`;
            div.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold">${test.name}</h3>
                        <p class="text-gray-600 text-sm">${test.description}</p>
                    </div>
                    <div class="flex items-center ml-4">
                        <i id="test-icon-${index}" class="fas fa-clock text-yellow-600 text-xl"></i>
                        <span id="test-status-${index}" class="ml-2 font-medium">Running...</span>
                    </div>
                </div>
                <div id="test-message-${index}" class="mt-3 text-sm"></div>
            `;
            return div;
        }
        
        function updateTestResult(index, status, message) {
            const testElement = document.getElementById(`test-${index}`);
            const icon = document.getElementById(`test-icon-${index}`);
            const statusText = document.getElementById(`test-status-${index}`);
            const messageDiv = document.getElementById(`test-message-${index}`);
            
            testElement.className = 'bg-white rounded-lg shadow p-6 test-result';
            
            if (status === 'success') {
                testElement.classList.add('test-success');
                icon.className = 'fas fa-check-circle text-green-600 text-xl';
                statusText.textContent = 'Passed';
                statusText.className = 'ml-2 font-medium text-green-600';
            } else {
                testElement.classList.add('test-error');
                icon.className = 'fas fa-times-circle text-red-600 text-xl';
                statusText.textContent = 'Failed';
                statusText.className = 'ml-2 font-medium text-red-600';
            }
            
            messageDiv.textContent = message;
        }
        
        // Auto-run tests on page load
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>
