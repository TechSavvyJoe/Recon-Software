<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Recon - Inventory Loading Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Vehicle Recon - Inventory Loading Test</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Backend API Test</h2>
            <div class="space-y-4">
                <button onclick="testBackendAPI()" class="bg-blue-500 text-white px-4 py-2 rounded">Test Backend Connection</button>
                <button onclick="testCSVLoading()" class="bg-green-500 text-white px-4 py-2 rounded">Test CSV Loading</button>
                <button onclick="testDetailersAPI()" class="bg-purple-500 text-white px-4 py-2 rounded">Test Detailers API</button>
            </div>
            <div id="test-results" class="mt-4 p-4 bg-gray-50 rounded"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Inventory Data</h2>
            <div id="inventory-data" class="bg-gray-50 p-4 rounded text-sm"></div>
        </div>
    </div>

    <script>
        let testResults = document.getElementById('test-results');
        let inventoryData = document.getElementById('inventory-data');

        function log(message) {
            testResults.innerHTML += '<div class="mb-2">' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            testResults.scrollTop = testResults.scrollHeight;
        }

        async function testBackendAPI() {
            try {
                log('Testing backend API...');
                const response = await fetch('/api/inventory/current');
                if (response.ok) {
                    const data = await response.json();
                    log('✅ Backend API working: ' + JSON.stringify(data));
                    return data;
                } else {
                    log('❌ Backend API failed: ' + response.status);
                    return null;
                }
            } catch (error) {
                log('❌ Backend API error: ' + error.message);
                return null;
            }
        }

        async function testCSVLoading() {
            try {
                log('Testing CSV loading...');
                
                // First try backend
                const inventoryInfo = await testBackendAPI();
                let csvResponse;
                
                if (inventoryInfo) {
                    csvResponse = await fetch(inventoryInfo.url);
                } else {
                    // Fallback to direct file
                    csvResponse = await fetch('./Recon -Mission Ford of Dearborn-2025-06-10-0955.csv');
                }

                if (csvResponse.ok) {
                    const csvText = await csvResponse.text();
                    log('✅ CSV file loaded, size: ' + csvText.length + ' characters');
                    
                    // Parse CSV
                    const vehicles = parseVehicleDataFromCSV(csvText);
                    log('✅ Parsed ' + vehicles.length + ' vehicles from CSV');
                    
                    // Display first few vehicles
                    inventoryData.innerHTML = '<pre>' + JSON.stringify(vehicles.slice(0, 3), null, 2) + '</pre>';
                    
                    return vehicles;
                } else {
                    log('❌ CSV loading failed: ' + csvResponse.status);
                    return [];
                }
            } catch (error) {
                log('❌ CSV loading error: ' + error.message);
                return [];
            }
        }

        async function testDetailersAPI() {
            try {
                log('Testing detailers API...');
                const response = await fetch('/api/detailers');
                if (response.ok) {
                    const detailers = await response.json();
                    log('✅ Detailers API working: ' + detailers.length + ' detailers found');
                    return detailers;
                } else {
                    log('❌ Detailers API failed: ' + response.status);
                    return [];
                }
            } catch (error) {
                log('❌ Detailers API error: ' + error.message);
                return [];
            }
        }

        function parseVehicleDataFromCSV(csvText) {
            const vehicles = [];
            
            if (typeof window.Papa !== 'undefined') {
                log('Using PapaParse for CSV parsing...');
                const results = window.Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: function(header) {
                        return header.replace(/["\r\n]/g, '').trim();
                    }
                });
                
                log('Papa Parse found ' + results.data.length + ' rows');
                
                results.data.forEach((row, index) => {
                    if (row['Stock #']) {
                        const vehicle = {
                            'Stock #': row['Stock #'] || '',
                            'VIN': row['VIN'] || '',
                            'Year': parseInt(row['Year']) || new Date().getFullYear(),
                            'Make': row['Make'] || '',
                            'Model': row['Model'] || '',
                            'Body': row['Body'] || '',
                            'Color': row['Color'] || '',
                            'Status': 'New Arrival',
                            'Detailer': '',
                            'Date In': row['Inventory Date'] || row['Created'] || new Date().toISOString().split('T')[0],
                            'Date Out': '',
                            'Notes': row['Tags'] ? `Tags: ${row['Tags']}` : '',
                            'Odometer': row['Odometer'] ? parseInt(row['Odometer'].toString().replace(/[,\s"]/g, '')) || 0 : 0,
                            'Original Cost': row['Original Cost'] || '',
                            'Unit Cost': row['Unit Cost'] || '',
                            'Vehicle Source': row['Vehicle Source'] || '',
                            'Photos': parseInt(row['Photos']) || 0,
                            'Last Updated': new Date().toISOString()
                        };
                        
                        vehicles.push(vehicle);
                    } else if (index < 5) {
                        log('Row ' + index + ' missing Stock #: ' + JSON.stringify(row));
                    }
                });
            } else {
                log('PapaParse not available, using manual parsing...');
                // Manual parsing fallback would go here
            }
            
            return vehicles;
        }

        // Auto-run tests when page loads
        window.addEventListener('load', async () => {
            log('=== Starting Inventory Loading Tests ===');
            await testBackendAPI();
            await testCSVLoading();
            await testDetailersAPI();
            log('=== Tests Complete ===');
        });
    </script>
</body>
</html>
