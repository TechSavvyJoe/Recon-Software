<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Reconditioning Tracker - Complete Working Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Enhanced styles for professional UI */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
        }
        .workflow-column {
            min-height: 400px;
            transition: all 0.3s ease;
        }
        .workflow-column.drag-over {
            background-color: #e0f2fe;
            border-color: #0284c7;
        }
        .vehicle-card {
            cursor: grab;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .vehicle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .vehicle-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .star-rating {
            color: #fbbf24;
            font-size: 1.2rem;
        }
        .star-rating .empty {
            color: #e5e7eb;
        }
        th.sortable {
            cursor: pointer;
            user-select: none;
        }
        th.sortable:hover {
            background-color: #f3f4f6;
        }
        .sort-arrow {
            display: inline-block;
            margin-left: 0.5rem;
            transition: transform 0.2s;
        }
        .sort-arrow.desc {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-lg shadow-lg mb-6">
            <h1 class="text-3xl font-bold flex items-center">
                <i class="fas fa-car mr-3"></i>
                Vehicle Reconditioning Tracker
            </h1>
            <p class="text-blue-100 mt-2">Complete workflow management with star ratings</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white rounded-lg shadow-md mb-6 overflow-x-auto">
            <div class="flex space-x-1 p-2" id="tabs">
                <button class="tab-button px-6 py-3 rounded-lg font-medium transition-all duration-200 bg-blue-500 text-white" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100" data-tab="workflow">
                    <i class="fas fa-tasks mr-2"></i>Workflow
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100" data-tab="inventory">
                    <i class="fas fa-warehouse mr-2"></i>Inventory
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100" data-tab="reports">
                    <i class="fas fa-chart-bar mr-2"></i>Reports
                </button>
                <button class="tab-button px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100" data-tab="upload">
                    <i class="fas fa-upload mr-2"></i>Import/Export
                </button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main>
            <!-- Dashboard Tab -->
            <div id="dashboard-content" class="tab-content active">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-6">Dashboard Overview</h2>
                    
                    <!-- Key Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="text-3xl font-bold mb-2" id="total-vehicles">0</div>
                            <div class="text-blue-100">Total Vehicles</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="text-3xl font-bold mb-2" id="lot-ready-count">0</div>
                            <div class="text-green-100">Lot Ready</div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="text-3xl font-bold mb-2" id="avg-days-recon">0</div>
                            <div class="text-yellow-100">Avg Days in Recon</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                            <div class="text-3xl font-bold mb-2" id="avg-condition">0</div>
                            <div class="text-purple-100">Avg Condition</div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <h3 class="text-xl font-bold mb-4">Recent Activity</h3>
                    <div id="recent-activity" class="space-y-3">
                        <!-- Activity items will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Workflow Tab -->
            <div id="workflow-content" class="tab-content">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-6">Workflow Board</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4" id="workflow-board">
                        <!-- Workflow columns will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory-content" class="tab-content">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Inventory Management</h2>
                        <div class="flex gap-3">
                            <input type="text" id="inventory-search" placeholder="Search vehicles..." 
                                   class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="showAddVehicleModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                <i class="fas fa-plus mr-2"></i>Add Vehicle
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="stockNumber">
                                        Stock # <span class="sort-arrow">↕</span>
                                    </th>
                                    <th class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="year">
                                        Year <span class="sort-arrow">↕</span>
                                    </th>
                                    <th class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="make">
                                        Make <span class="sort-arrow">↕</span>
                                    </th>
                                    <th class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="model">
                                        Model <span class="sort-arrow">↕</span>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Status
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Condition
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="inventory-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Inventory rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-content" class="tab-content">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-6">Reports & Analytics</h2>
                    
                    <!-- Bottleneck Analysis -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold mb-4">Bottleneck Analysis</h3>
                        <div id="bottleneck-analysis" class="space-y-4">
                            <!-- Bottleneck items will be populated here -->
                        </div>
                    </div>

                    <!-- Condition Reports -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border rounded-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Average Exterior Condition</h3>
                            <div id="avg-exterior" class="text-3xl star-rating text-center">
                                <!-- Stars will be populated here -->
                            </div>
                        </div>
                        <div class="border rounded-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Average Interior Condition</h3>
                            <div id="avg-interior" class="text-3xl star-rating text-center">
                                <!-- Stars will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload/Import Tab -->
            <div id="upload-content" class="tab-content">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-6">Data Import/Export</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Import Section -->
                        <div class="border rounded-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Import CSV</h3>
                            <input type="file" id="csv-file-input" accept=".csv" 
                                   class="mb-4 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            <button onclick="handleCsvImport()" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                <i class="fas fa-upload mr-2"></i>Import CSV
                            </button>
                        </div>

                        <!-- Export Section -->
                        <div class="border rounded-lg p-6">
                            <h3 class="text-lg font-bold mb-4">Export Data</h3>
                            <button onclick="exportToCSV()" class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 mb-3">
                                <i class="fas fa-download mr-2"></i>Export to CSV
                            </button>
                            <button onclick="exportToJSON()" class="w-full px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                                <i class="fas fa-file-code mr-2"></i>Export to JSON
                            </button>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="mt-6 border rounded-lg p-6 bg-red-50">
                        <h3 class="text-lg font-bold mb-4 text-red-800">Data Management</h3>
                        <div class="flex gap-3">
                            <button onclick="loadSampleData()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                                <i class="fas fa-database mr-2"></i>Load Sample Data
                            </button>
                            <button onclick="clearAllData()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                <i class="fas fa-trash mr-2"></i>Clear All Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Vehicle Detail Modal -->
    <div id="vehicle-modal" class="modal">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-11/12 max-w-2xl mx-auto my-8">
            <div class="modal-header bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-t-lg">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold" id="modal-title">Vehicle Details</h3>
                    <button onclick="closeModal()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body p-6" id="modal-body">
                <!-- Modal content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Complete JavaScript Implementation -->
    <script>
        // Global state
        let vehicles = [];
        let currentSort = { field: null, direction: 'asc' };
        let draggedVehicle = null;

        const WORKFLOW_STATUSES = [
            'New Arrival', 'Mechanical', 'Detailing', 'Photos', 'Title', 'Lot Ready'
        ];

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
            initializeTabs();
            initializeWorkflow();
            renderAllContent();
        });

        // Tab Management
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    // Update button states
                    tabButtons.forEach(btn => {
                        btn.classList.remove('bg-blue-500', 'text-white');
                        btn.classList.add('hover:bg-gray-100');
                    });
                    this.classList.add('bg-blue-500', 'text-white');
                    this.classList.remove('hover:bg-gray-100');
                    
                    // Show corresponding content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${targetTab}-content`).classList.add('active');
                    
                    // Refresh content if needed
                    if (targetTab === 'reports') updateReports();
                });
            });
        }

        // Data Management
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('vehicleReconData');
            if (savedData) {
                vehicles = JSON.parse(savedData);
            } else {
                vehicles = [];
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('vehicleReconData', JSON.stringify(vehicles));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Star Rating Helper
        function renderStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<i class="fas fa-star ${i <= rating ? '' : 'empty'}"></i>`;
            }
            return stars;
        }

        // Dashboard Functions
        function updateDashboard() {
            // Update metrics
            document.getElementById('total-vehicles').textContent = vehicles.length;
            
            const lotReady = vehicles.filter(v => v.status === 'Lot Ready').length;
            document.getElementById('lot-ready-count').textContent = lotReady;
            
            const avgDays = vehicles.length > 0 
                ? Math.round(vehicles.reduce((sum, v) => sum + (v.daysInRecon || 0), 0) / vehicles.length)
                : 0;
            document.getElementById('avg-days-recon').textContent = avgDays;
            
            const avgCondition = vehicles.length > 0
                ? ((vehicles.reduce((sum, v) => sum + (v.exteriorRating || 3) + (v.interiorRating || 3), 0) / (vehicles.length * 2))).toFixed(1)
                : '0';
            document.getElementById('avg-condition').textContent = avgCondition;
            
            // Recent activity
            const recentActivity = document.getElementById('recent-activity');
            recentActivity.innerHTML = '';
            
            const recentVehicles = [...vehicles]
                .sort((a, b) => new Date(b.lastUpdated || 0) - new Date(a.lastUpdated || 0))
                .slice(0, 5);
            
            recentVehicles.forEach(vehicle => {
                const activityItem = document.createElement('div');
                activityItem.className = 'p-4 border rounded-lg hover:bg-gray-50 cursor-pointer';
                activityItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium">${vehicle.year} ${vehicle.make} ${vehicle.model}</div>
                            <div class="text-sm text-gray-500">Stock #: ${vehicle.stockNumber}</div>
                        </div>
                        <div class="text-right">
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(vehicle.status)}">
                                ${vehicle.status}
                            </span>
                            <div class="text-xs text-gray-500 mt-1">${formatDate(vehicle.lastUpdated)}</div>
                        </div>
                    </div>
                `;
                activityItem.onclick = () => showVehicleModal(vehicle.id);
                recentActivity.appendChild(activityItem);
            });
        }

        // Workflow Functions
        function initializeWorkflow() {
            const workflowBoard = document.getElementById('workflow-board');
            workflowBoard.innerHTML = '';
            
            WORKFLOW_STATUSES.forEach(status => {
                const column = document.createElement('div');
                column.className = 'workflow-column bg-gray-50 rounded-lg p-4 border-2 border-gray-200';
                column.dataset.status = status;
                column.innerHTML = `
                    <h3 class="font-bold text-center mb-3 text-gray-700">${status}</h3>
                    <div class="space-y-2" id="column-${status.replace(/\s+/g, '-')}">
                        <!-- Vehicles will be added here -->
                    </div>
                `;
                
                // Add drag and drop event listeners
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
                
                workflowBoard.appendChild(column);
            });
        }

        function updateWorkflow() {
            // Clear all columns first
            WORKFLOW_STATUSES.forEach(status => {
                const columnId = `column-${status.replace(/\s+/g, '-')}`;
                const column = document.getElementById(columnId);
                if (column) column.innerHTML = '';
            });
            
            // Add vehicles to appropriate columns
            vehicles.forEach(vehicle => {
                const columnId = `column-${vehicle.status.replace(/\s+/g, '-')}`;
                const column = document.getElementById(columnId);
                
                if (column) {
                    const card = document.createElement('div');
                    card.className = 'vehicle-card bg-white p-3 rounded-lg shadow-md border-2 border-transparent hover:border-blue-400';
                    card.draggable = true;
                    card.dataset.vehicleId = vehicle.id;
                    card.innerHTML = `
                        <div class="font-medium text-sm">${vehicle.year} ${vehicle.make} ${vehicle.model}</div>
                        <div class="text-xs text-gray-500">Stock #: ${vehicle.stockNumber}</div>
                        <div class="text-xs mt-1">
                            <span class="star-rating">${renderStars(Math.round((vehicle.exteriorRating + vehicle.interiorRating) / 2))}</span>
                        </div>
                    `;
                    
                    // Add drag event listeners
                    card.addEventListener('dragstart', handleDragStart);
                    card.addEventListener('dragend', handleDragEnd);
                    card.addEventListener('click', () => showVehicleModal(vehicle.id));
                    
                    column.appendChild(card);
                }
            });
        }

        // Drag and Drop Handlers
        function handleDragStart(e) {
            draggedVehicle = e.target.dataset.vehicleId;
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            if (e.target.classList.contains('workflow-column')) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('workflow-column')) {
                e.target.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const column = e.target.closest('.workflow-column');
            if (column) {
                column.classList.remove('drag-over');
                const newStatus = column.dataset.status;
                const vehicleIndex = vehicles.findIndex(v => v.id === draggedVehicle);
                
                if (vehicleIndex !== -1) {
                    vehicles[vehicleIndex].status = newStatus;
                    vehicles[vehicleIndex].lastUpdated = new Date().toISOString();
                    saveToLocalStorage();
                    updateWorkflow();
                    updateDashboard();
                    showNotification(`Vehicle moved to ${newStatus}`);
                }
            }
        }

        // Inventory Functions
        function updateInventory() {
            const tbody = document.getElementById('inventory-tbody');
            const searchTerm = document.getElementById('inventory-search').value.toLowerCase();
            
            let filteredVehicles = vehicles.filter(v => 
                v.stockNumber.toLowerCase().includes(searchTerm) ||
                v.make.toLowerCase().includes(searchTerm) ||
                v.model.toLowerCase().includes(searchTerm) ||
                v.vin.toLowerCase().includes(searchTerm)
            );
            
            // Apply sorting
            if (currentSort.field) {
                filteredVehicles.sort((a, b) => {
                    let aVal = a[currentSort.field];
                    let bVal = b[currentSort.field];
                    
                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    
                    if (currentSort.direction === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
            }
            
            tbody.innerHTML = '';
            filteredVehicles.forEach(vehicle => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${vehicle.stockNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${vehicle.year}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${vehicle.make}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${vehicle.model}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(vehicle.status)}">
                            ${vehicle.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="star-rating text-sm">
                            ${renderStars(Math.round((vehicle.exteriorRating + vehicle.interiorRating) / 2))}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="showVehicleModal('${vehicle.id}')" class="text-blue-600 hover:text-blue-800 mr-3">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="deleteVehicle('${vehicle.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Sorting
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', function() {
                const field = this.dataset.sort;
                
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'asc';
                }
                
                // Update arrow indicators
                document.querySelectorAll('.sort-arrow').forEach(arrow => {
                    arrow.textContent = '↕';
                    arrow.classList.remove('desc');
                });
                
                const arrow = this.querySelector('.sort-arrow');
                arrow.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
                if (currentSort.direction === 'desc') {
                    arrow.classList.add('desc');
                }
                
                updateInventory();
            });
        });

        // Search functionality
        document.getElementById('inventory-search').addEventListener('input', updateInventory);

        // Reports Functions
        function updateReports() {
            // Bottleneck Analysis
            const bottleneckDiv = document.getElementById('bottleneck-analysis');
            bottleneckDiv.innerHTML = '';
            
            const statusCounts = {};
            WORKFLOW_STATUSES.forEach(status => {
                statusCounts[status] = vehicles.filter(v => v.status === status).length;
            });
            
            // Identify bottlenecks (stages with most vehicles)
            const bottlenecks = Object.entries(statusCounts)
                .sort((a, b) => b[1] - a[1])
                .filter(([status, count]) => count > 0 && status !== 'Lot Ready');
            
            bottlenecks.forEach(([status, count]) => {
                const severity = count > 5 ? 'high' : count > 2 ? 'medium' : 'low';
                const severityColor = severity === 'high' ? 'red' : severity === 'medium' ? 'yellow' : 'green';
                
                const item = document.createElement('div');
                item.className = `p-4 border-l-4 border-${severityColor}-500 bg-${severityColor}-50 rounded`;
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium text-${severityColor}-800">${status}</div>
                            <div class="text-sm text-${severityColor}-600">${count} vehicles stuck at this stage</div>
                        </div>
                        <div class="text-2xl font-bold text-${severityColor}-700">${count}</div>
                    </div>
                `;
                bottleneckDiv.appendChild(item);
            });
            
            // Average Conditions
            const avgExterior = vehicles.length > 0
                ? vehicles.reduce((sum, v) => sum + (v.exteriorRating || 3), 0) / vehicles.length
                : 3;
            const avgInterior = vehicles.length > 0
                ? vehicles.reduce((sum, v) => sum + (v.interiorRating || 3), 0) / vehicles.length
                : 3;
            
            document.getElementById('avg-exterior').innerHTML = renderStars(Math.round(avgExterior));
            document.getElementById('avg-interior').innerHTML = renderStars(Math.round(avgInterior));
        }

        // Modal Functions
        function showVehicleModal(vehicleId) {
            const vehicle = vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            const modal = document.getElementById('vehicle-modal');
            const modalBody = document.getElementById('modal-body');
            
            document.getElementById('modal-title').textContent = 
                `${vehicle.year} ${vehicle.make} ${vehicle.model}`;
            
            modalBody.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Stock Number</label>
                        <p class="text-lg">${vehicle.stockNumber}</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">VIN</label>
                        <p class="text-lg font-mono">${vehicle.vin}</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Color</label>
                        <p class="text-lg">${vehicle.color || 'N/A'}</p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Odometer</label>
                        <p class="text-lg">${vehicle.odometer ? vehicle.odometer.toLocaleString() : 'N/A'}</p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="text-sm font-medium text-gray-700">Current Status</label>
                    <select id="modal-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        ${WORKFLOW_STATUSES.map(status => 
                            `<option value="${status}" ${vehicle.status === status ? 'selected' : ''}>${status}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Exterior Condition</label>
                        <div class="flex gap-2 mt-2">
                            ${[1,2,3,4,5].map(rating => 
                                `<button onclick="setRating('${vehicleId}', 'exterior', ${rating})" 
                                         class="px-3 py-2 border rounded ${vehicle.exteriorRating === rating ? 'bg-blue-500 text-white' : 'bg-white'}">
                                    ${rating}★
                                </button>`
                            ).join('')}
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Interior Condition</label>
                        <div class="flex gap-2 mt-2">
                            ${[1,2,3,4,5].map(rating => 
                                `<button onclick="setRating('${vehicleId}', 'interior', ${rating})" 
                                         class="px-3 py-2 border rounded ${vehicle.interiorRating === rating ? 'bg-blue-500 text-white' : 'bg-white'}">
                                    ${rating}★
                                </button>`
                            ).join('')}
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="text-sm font-medium text-gray-700">Notes</label>
                    <textarea id="modal-notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">${vehicle.notes || ''}</textarea>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        Cancel
                    </button>
                    <button onclick="saveVehicleChanges('${vehicleId}')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        Save Changes
                    </button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('vehicle-modal').style.display = 'none';
        }

        function setRating(vehicleId, type, rating) {
            const vehicle = vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            if (type === 'exterior') {
                vehicle.exteriorRating = rating;
            } else {
                vehicle.interiorRating = rating;
            }
            
            // Re-render the modal to update button states
            showVehicleModal(vehicleId);
        }

        function saveVehicleChanges(vehicleId) {
            const vehicle = vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            vehicle.status = document.getElementById('modal-status').value;
            vehicle.notes = document.getElementById('modal-notes').value;
            vehicle.lastUpdated = new Date().toISOString();
            
            saveToLocalStorage();
            renderAllContent();
            closeModal();
            showNotification('Vehicle updated successfully');
        }

        function showAddVehicleModal() {
            const modal = document.getElementById('vehicle-modal');
            const modalBody = document.getElementById('modal-body');
            
            document.getElementById('modal-title').textContent = 'Add New Vehicle';
            
            modalBody.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="text-sm font-medium text-gray-700">Stock Number*</label>
                        <input type="text" id="new-stock" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">VIN*</label>
                        <input type="text" id="new-vin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Year*</label>
                        <input type="number" id="new-year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Make*</label>
                        <input type="text" id="new-make" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Model*</label>
                        <input type="text" id="new-model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-700">Color</label>
                        <input type="text" id="new-color" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        Cancel
                    </button>
                    <button onclick="addNewVehicle()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        Add Vehicle
                    </button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function addNewVehicle() {
            const stockNumber = document.getElementById('new-stock').value.trim();
            const vin = document.getElementById('new-vin').value.trim();
            const year = document.getElementById('new-year').value;
            const make = document.getElementById('new-make').value.trim();
            const model = document.getElementById('new-model').value.trim();
            const color = document.getElementById('new-color').value.trim();
            
            if (!stockNumber || !vin || !year || !make || !model) {
                alert('Please fill in all required fields');
                return;
            }
            
            const newVehicle = {
                id: generateId(),
                stockNumber,
                vin,
                year: parseInt(year),
                make,
                model,
                color,
                status: 'New Arrival',
                exteriorRating: 3,
                interiorRating: 3,
                notes: '',
                dateAdded: new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
                daysInRecon: 0,
                odometer: 0
            };
            
            vehicles.push(newVehicle);
            saveToLocalStorage();
            renderAllContent();
            closeModal();
            showNotification('Vehicle added successfully');
        }

        function deleteVehicle(vehicleId) {
            if (confirm('Are you sure you want to delete this vehicle?')) {
                vehicles = vehicles.filter(v => v.id !== vehicleId);
                saveToLocalStorage();
                renderAllContent();
                showNotification('Vehicle deleted successfully');
            }
        }

        // Import/Export Functions
        function handleCsvImport() {
            const fileInput = document.getElementById('csv-file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file');
                return;
            }
            
            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    const importedVehicles = results.data
                        .filter(row => row['Stock #'] && row.VIN) // Filter out empty rows
                        .map(row => ({
                            id: generateId(),
                            stockNumber: row['Stock #'] || '',
                            vin: row.VIN || '',
                            year: parseInt(row.Year) || new Date().getFullYear(),
                            make: row.Make || '',
                            model: row.Model || '',
                            color: row.Color || row.Body || '',
                            status: 'New Arrival',
                            exteriorRating: 3,
                            interiorRating: 3,
                            notes: '',
                            dateAdded: new Date().toISOString(),
                            lastUpdated: new Date().toISOString(),
                            daysInRecon: parseInt(row.Age) || 0,
                            odometer: parseInt(row.Odometer?.replace(/,/g, '')) || 0,
                            source: row['Vehicle Source'] || '',
                            cost: row['Unit Cost'] || ''
                        }));
                    
                    if (importedVehicles.length > 0) {
                        vehicles = [...vehicles, ...importedVehicles];
                        saveToLocalStorage();
                        renderAllContent();
                        showNotification(`Imported ${importedVehicles.length} vehicles successfully`);
                        fileInput.value = '';
                    } else {
                        alert('No valid vehicles found in the CSV file');
                    }
                },
                error: function(error) {
                    alert('Error parsing CSV file: ' + error.message);
                }
            });
        }

        function exportToCSV() {
            const headers = [
                'Stock #', 'VIN', 'Year', 'Make', 'Model', 'Color', 
                'Status', 'Exterior Rating', 'Interior Rating', 
                'Days in Recon', 'Odometer', 'Notes', 'Last Updated'
            ];
            
            const rows = vehicles.map(v => [
                v.stockNumber,
                v.vin,
                v.year,
                v.make,
                v.model,
                v.color || '',
                v.status,
                v.exteriorRating,
                v.interiorRating,
                v.daysInRecon || 0,
                v.odometer || 0,
                v.notes || '',
                formatDate(v.lastUpdated)
            ]);
            
            const csv = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
            
            downloadFile(csv, 'vehicle-inventory.csv', 'text/csv');
        }

        function exportToJSON() {
            const json = JSON.stringify(vehicles, null, 2);
            downloadFile(json, 'vehicle-inventory.json', 'application/json');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadSampleData() {
            if (vehicles.length > 0 && !confirm('This will replace your current data. Continue?')) {
                return;
            }
            
            vehicles = [
                {
                    id: generateId(),
                    stockNumber: 'T250518A',
                    vin: '1FMCU9G67LUC03251',
                    year: 2020,
                    make: 'Ford',
                    model: 'Escape',
                    color: 'Blue Metallic',
                    status: 'Mechanical',
                    exteriorRating: 4,
                    interiorRating: 3,
                    notes: 'Minor scratches on rear bumper',
                    dateAdded: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    daysInRecon: 5,
                    odometer: 16061
                },
                {
                    id: generateId(),
                    stockNumber: 'T7784P',
                    vin: '3GNKBHR48NS179564',
                    year: 2022,
                    make: 'Chevrolet',
                    model: 'Blazer',
                    color: 'Iron Gray Metallic',
                    status: 'Detailing',
                    exteriorRating: 5,
                    interiorRating: 4,
                    notes: 'Excellent condition',
                    dateAdded: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    daysInRecon: 3,
                    odometer: 36613
                },
                {
                    id: generateId(),
                    stockNumber: 'T250521A',
                    vin: '1FM5K8D81FGA63683',
                    year: 2015,
                    make: 'Ford',
                    model: 'Explorer',
                    color: 'Ingot Silver',
                    status: 'Photos',
                    exteriorRating: 3,
                    interiorRating: 3,
                    notes: 'Needs interior deep clean',
                    dateAdded: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    daysInRecon: 7,
                    odometer: 83000
                }
            ];
            
            saveToLocalStorage();
            renderAllContent();
            showNotification('Sample data loaded successfully');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                vehicles = [];
                saveToLocalStorage();
                renderAllContent();
                showNotification('All data cleared');
            }
        }

        // Helper Functions
        function getStatusColor(status) {
            const colors = {
                'New Arrival': 'bg-blue-100 text-blue-800',
                'Mechanical': 'bg-yellow-100 text-yellow-800',
                'Detailing': 'bg-purple-100 text-purple-800',
                'Photos': 'bg-pink-100 text-pink-800',
                'Title': 'bg-orange-100 text-orange-800',
                'Lot Ready': 'bg-green-100 text-green-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function renderAllContent() {
            updateDashboard();
            updateWorkflow();
            updateInventory();
            updateReports();
        }

        // Modal close on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('vehicle-modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
            link.download = `vehicle-recon-report-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Report generated and downloaded!', 'success');
        }

        // Click outside modal to close
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
    </script>
</body>
</html>
